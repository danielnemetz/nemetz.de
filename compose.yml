services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_ID: ${BUILD_ID:-local-dev}
    container_name: nemetz-de-web
    restart: unless-stopped
    networks:
      - traefik-network
    labels:
      - 'traefik.enable=true'

      # Middleware: Compression
      # Enable gzip/brotli compression for responses
      - 'traefik.http.middlewares.nemetz-compress.compress=true'

      # Middleware: Security Headers
      # Enforce HTTPS redirects and set security-related HTTP headers
      - 'traefik.http.middlewares.nemetz-security.headers.sslredirect=true'
      - 'traefik.http.middlewares.nemetz-security.headers.stsseconds=31536000'
      - 'traefik.http.middlewares.nemetz-security.headers.stsincludesubdomains=true'
      - 'traefik.http.middlewares.nemetz-security.headers.stspreload=true'
      - 'traefik.http.middlewares.nemetz-security.headers.contenttypenosniff=true'
      - 'traefik.http.middlewares.nemetz-security.headers.browserxssfilter=true'

      # Middleware: Proxy Headers
      # Forward X-Forwarded-Proto to backend for proper scheme detection
      - 'traefik.http.middlewares.nemetz-proxy-headers.headers.customrequestheaders.X-Forwarded-Proto=https'

      # Router: HTTPS (websecure entrypoint)
      # Matches all requests to nemetz.de via TLS
      - 'traefik.http.routers.nemetz-de.rule=Host(`nemetz.de`)'
      - 'traefik.http.routers.nemetz-de.entrypoints=websecure'
      - 'traefik.http.routers.nemetz-de.tls.certresolver=cloudflare'
      - 'traefik.http.routers.nemetz-de.middlewares=nemetz-compress,nemetz-security,nemetz-proxy-headers@docker'
      - 'traefik.http.routers.nemetz-de.service=nemetz-de'

      # Router: HTTP (web entrypoint)
      # Redirects HTTP to HTTPS via security middleware
      - 'traefik.http.routers.nemetz-de-http.rule=Host(`nemetz.de`)'
      - 'traefik.http.routers.nemetz-de-http.entrypoints=web'
      - 'traefik.http.routers.nemetz-de-http.middlewares=nemetz-security'
      - 'traefik.http.routers.nemetz-de-http.service=nemetz-de'

      # Service Definition
      - 'traefik.http.services.nemetz-de.loadbalancer.server.port=3000'

networks:
  traefik-network:
    external: true
